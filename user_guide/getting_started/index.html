
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://arnarg.github.io/nixidy/user_guide/getting_started/">
      
      
        <link rel="prev" href="../..">
      
      
        <link rel="next" href="../github_actions/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.3.1">
    
    
      
        <title>Getting Started - nixidy</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.046329b4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.85d0ee34.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#getting-started" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="nixidy" class="md-header__button md-logo" aria-label="nixidy" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            nixidy
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Getting Started
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/arnarg/nixidy/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="nixidy" class="md-nav__button md-logo" aria-label="nixidy" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    nixidy
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/arnarg/nixidy/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#initialize-repository" class="md-nav__link">
    Initialize Repository
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#our-first-application" class="md-nav__link">
    Our first Application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modularizing-the-configuration" class="md-nav__link">
    Modularizing the Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#abstracting-options-on-top-of-applications" class="md-nav__link">
    Abstracting Options on top of Applications
  </a>
  
    <nav class="md-nav" aria-label="Abstracting Options on top of Applications">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#traefik" class="md-nav__link">
    Traefik
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#argo-cd" class="md-nav__link">
    Argo CD
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#putting-it-all-together" class="md-nav__link">
    Putting it all together
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../github_actions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GitHub Actions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../transformers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Transformers
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../library/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Library Functions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../options/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration Options
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#initialize-repository" class="md-nav__link">
    Initialize Repository
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#our-first-application" class="md-nav__link">
    Our first Application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modularizing-the-configuration" class="md-nav__link">
    Modularizing the Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#abstracting-options-on-top-of-applications" class="md-nav__link">
    Abstracting Options on top of Applications
  </a>
  
    <nav class="md-nav" aria-label="Abstracting Options on top of Applications">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#traefik" class="md-nav__link">
    Traefik
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#argo-cd" class="md-nav__link">
    Argo CD
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#putting-it-all-together" class="md-nav__link">
    Putting it all together
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="getting-started">Getting Started<a class="headerlink" href="#getting-started" title="Permanent link">#</a></h1>
<p>Nixidy only supports <a href="https://nixos.wiki/wiki/Flakes">Nix Flakes</a> so that needs to be enabled.</p>
<h2 id="initialize-repository">Initialize Repository<a class="headerlink" href="#initialize-repository" title="Permanent link">#</a></h2>
<p>First a <code>flake.nix</code> needs to be created in the root of the repository.</p>
<div class="highlight"><span class="filename">flake.nix</span><pre><span></span><code><span class="p">{</span>
  <span class="ss">description =</span> <span class="s2">&quot;My ArgoCD configuration with nixidy.&quot;</span><span class="p">;</span>

  inputs<span class="o">.</span>nixpkgs<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:nixos/nixpkgs/nixos-unstable&quot;</span><span class="p">;</span>
  inputs<span class="o">.</span>flake-utils<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:numtide/flake-utils&quot;</span><span class="p">;</span>
  inputs<span class="o">.</span>nixidy<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:arnarg/nixidy&quot;</span><span class="p">;</span>

  <span class="ss">outputs =</span> <span class="p">{</span>
    self<span class="p">,</span>
    nixpkgs<span class="p">,</span>
    flake-utils<span class="p">,</span>
    nixidy<span class="p">,</span>
  <span class="p">}:</span> <span class="p">(</span>flake-utils<span class="o">.</span>lib<span class="o">.</span>eachDefaultSystem <span class="p">(</span>system<span class="p">:</span> <span class="k">let</span>
    <span class="ss">pkgs =</span> <span class="nb">import</span> nixpkgs <span class="p">{</span>
      <span class="k">inherit</span> system<span class="p">;</span>
    <span class="p">};</span>
  <span class="k">in</span> <span class="p">{</span>
    <span class="c1"># This declares the available nixidy envs.</span>
    <span class="ss">nixidyEnvs =</span> nixidy<span class="o">.</span>lib<span class="o">.</span>mkEnvs <span class="p">{</span>
      <span class="k">inherit</span> pkgs<span class="p">;</span>

      <span class="ss">envs =</span> <span class="p">{</span>
        <span class="c1"># Currently we only have the one dev env.</span>
        dev<span class="o">.</span><span class="ss">modules =</span> <span class="p">[</span><span class="o">.</span><span class="l">/env/dev.nix</span><span class="p">];</span>
      <span class="p">};</span>
    <span class="p">};</span>

    <span class="c1"># Handy to have nixidy cli available in the local</span>
    <span class="c1"># flake too.</span>
    packages<span class="o">.</span><span class="ss">nixidy =</span> nixidy<span class="o">.</span>packages<span class="o">.</span><span class="err">$</span><span class="p">{</span>system<span class="p">}</span><span class="o">.</span>default<span class="p">;</span>

    <span class="c1"># Useful development shell with nixidy in path.</span>
    <span class="c1"># Run `nix develop` to enter.</span>
    devShells<span class="o">.</span><span class="ss">default =</span> pkgs<span class="o">.</span>mkShell <span class="p">{</span>
      <span class="ss">buildInputs =</span> <span class="p">[</span>nixidy<span class="o">.</span>packages<span class="o">.</span><span class="err">$</span><span class="p">{</span>system<span class="p">}</span><span class="o">.</span>default<span class="p">];</span>
    <span class="p">};</span>
  <span class="p">}));</span>
<span class="p">}</span>
</code></pre></div>
<p>The flake declares a single nixidy environment called <code>dev</code>. It includes a single nix module found at <code>./env/dev.nix</code>, so let's create that.</p>
<div class="highlight"><span class="filename">env/dev.nix</span><pre><span></span><code><span class="p">{</span>
  <span class="c1"># Set the target repository for the rendered manifests</span>
  <span class="c1"># and applications.</span>
  <span class="c1"># This should be replaced with yours, usually the same</span>
  <span class="c1"># repository as the nixidy definitions.</span>
  nixidy<span class="o">.</span>target<span class="o">.</span><span class="ss">repository =</span> <span class="s2">&quot;https://github.com/arnarg/nixidy-demo.git&quot;</span><span class="p">;</span>

  <span class="c1"># Set the target branch the rendered manifests for _this_</span>
  <span class="c1"># environment should be pushed to in the repository defined</span>
  <span class="c1"># above.</span>
  <span class="c1"># When using `mkEnvs` function in flake.nix it wil automatically</span>
  <span class="c1"># set this to `&quot;env/${name}&quot;`.</span>
  nixidy<span class="o">.</span>target<span class="o">.</span><span class="ss">branch =</span> <span class="s2">&quot;env/dev&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Now runnig <code>nix run .#nixidy -- info .#dev</code> (or simply <code>nixidy info .#dev</code> if run in nix shell using <code>nix develop</code>) you can get the same info we just declared above. This verifies that things are set up correctly so far.</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;<span class="w"> </span>nix<span class="w"> </span>run<span class="w"> </span>.#nixidy<span class="w"> </span>--<span class="w"> </span>info<span class="w"> </span>.#dev
Repository:<span class="w"> </span>https://github.com/arnarg/nixidy-demo.git
Branch:<span class="w">     </span>env/dev
</code></pre></div>
<p>If we now attempt to build this new environment with <code>nix run .#nixidy -- build .#dev</code> we can see that nothing is generated but an empty folder called <code>apps</code>.</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;<span class="w"> </span>tree<span class="w"> </span>result
result
└──<span class="w"> </span>apps/
</code></pre></div>
<p>This is because we have not declared any applications yet for this environment.</p>
<h2 id="our-first-application">Our first Application<a class="headerlink" href="#our-first-application" title="Permanent link">#</a></h2>
<p>While nixidy allows you to declare all of the application's resources directly in nix it would be a waste to not be able to use Helm charts and Kustomize applications that already exists and are often officially maintained by project maintainers.</p>
<p>The application's declaration is very similar whichever option you go with.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Helm</label><label for="__tabbed_1_2">Kustomize</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">env/dev.nix</span><pre><span></span><code><span class="p">{</span>lib<span class="p">,</span> <span class="o">...</span><span class="p">}:</span> <span class="p">{</span>
  <span class="c1"># Options explained in the section above.</span>
  nixidy<span class="o">.</span>target<span class="o">.</span><span class="ss">repository =</span> <span class="s2">&quot;https://github.com/arnarg/nixidy-demo.git&quot;</span><span class="p">;</span>
  nixidy<span class="o">.</span>target<span class="o">.</span><span class="ss">branch =</span> <span class="s2">&quot;env/dev&quot;</span><span class="p">;</span>

  <span class="c1"># Argo CD application using the Helm chart from argo-helm.</span>
  applications<span class="o">.</span><span class="ss">argocd =</span> <span class="p">{</span>
    <span class="c1"># Declare the destination namespace for the application.</span>
    <span class="ss">namespace =</span> <span class="s2">&quot;argocd&quot;</span><span class="p">;</span>

    <span class="c1"># Instruct nixidy to automatically create a `Namespace`</span>
    <span class="c1"># manifest in the rendered manifests for namespace</span>
    <span class="c1"># selected above.</span>
    <span class="ss">createNamespace =</span> <span class="no">true</span><span class="p">;</span>

    <span class="c1"># Specify Helm chart with values to template with.</span>
    helm<span class="o">.</span>releases<span class="o">.</span><span class="ss">argocd =</span> <span class="p">{</span>
      <span class="c1"># Using `downloadHelmChart` we can download</span>
      <span class="c1"># the helm chart using nix.</span>
      <span class="c1"># The value for `chartHash` needs to be updated</span>
      <span class="c1"># with each version.</span>
      <span class="ss">chart =</span> lib<span class="o">.</span>helm<span class="o">.</span>downloadHelmChart <span class="p">{</span>
        <span class="ss">repo =</span> <span class="s2">&quot;https://argoproj.github.io/argo-helm/&quot;</span><span class="p">;</span>
        <span class="ss">chart =</span> <span class="s2">&quot;argo-cd&quot;</span><span class="p">;</span>
        <span class="ss">version =</span> <span class="s2">&quot;5.51.6&quot;</span><span class="p">;</span>
        <span class="ss">chartHash =</span> <span class="s2">&quot;sha256-3kRkzOQdYa5JkrBV/+iJK3FP+LDFY1J8L20aPhcEMkY=&quot;</span><span class="p">;</span>
      <span class="p">};</span>

      <span class="c1"># Specify values to pass to the chart.</span>
      <span class="ss">values =</span> <span class="p">{</span>
        <span class="c1"># Run argocd-server with 2 replicas.</span>
        <span class="c1"># This is an option in the chart&#39;s `values.yaml`</span>
        <span class="c1"># usually declared like this:</span>
        <span class="c1">#</span>
        <span class="c1"># server:</span>
        <span class="c1">#   replicas: 2</span>
        server<span class="o">.</span><span class="ss">replicas =</span> <span class="mi">2</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><span class="filename">env/dev.nix</span><pre><span></span><code><span class="p">{</span>pkgs<span class="p">,</span> <span class="o">...</span><span class="p">}:</span> <span class="p">{</span>
  <span class="c1"># Options explained in the section above.</span>
  nixidy<span class="o">.</span>target<span class="o">.</span><span class="ss">repository =</span> <span class="s2">&quot;https://github.com/arnarg/nixidy-demo.git&quot;</span><span class="p">;</span>
  nixidy<span class="o">.</span>target<span class="o">.</span><span class="ss">branch =</span> <span class="s2">&quot;env/dev&quot;</span><span class="p">;</span>

  <span class="c1"># Argo CD application using the official kustomize application</span>
  <span class="c1"># from Argo CD git repository.</span>
  applications<span class="o">.</span><span class="ss">argocd =</span> <span class="p">{</span>
    <span class="c1"># Declare the destination namespace for the application.</span>
    <span class="ss">namespace =</span> <span class="s2">&quot;argocd&quot;</span><span class="p">;</span>

    <span class="c1"># Instruct nixidy to automatically create a `Namespace`</span>
    <span class="c1"># manifest in the rendered manifests for namespace</span>
    <span class="c1"># selected above.</span>
    <span class="ss">createNamespace =</span> <span class="no">true</span><span class="p">;</span>

    <span class="c1"># Specify Kustomize application to render.</span>
    kustomize<span class="o">.</span>applications<span class="o">.</span><span class="ss">argocd =</span> <span class="p">{</span>
      <span class="c1"># Equivalent to `github.com/argoproj/argo-cd/manifests/cluster-install?ref=v2.9.3`</span>
      <span class="c1"># in kustomization.yaml.</span>
      <span class="ss">kustomization =</span> <span class="p">{</span>
        <span class="ss">src =</span> pkgs<span class="o">.</span>fetchFromGitHub <span class="p">{</span>
          <span class="ss">owner =</span> <span class="s2">&quot;argoproj&quot;</span><span class="p">;</span>
          <span class="ss">repo =</span> <span class="s2">&quot;argo-cd&quot;</span><span class="p">;</span>
          <span class="ss">rev =</span> <span class="s2">&quot;v2.9.3&quot;</span><span class="p">;</span>
          <span class="ss">hash =</span> <span class="s2">&quot;sha256-GaY4Cw/LlSwy35umbB4epXt6ev8ya19UjHRwhDwilqU=&quot;</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="ss">path =</span> <span class="s2">&quot;manifests/cluster-install&quot;</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>In both cases the following output will be generated:</p>
<div class="highlight"><pre><span></span><code>tree<span class="w"> </span>-l<span class="w"> </span>result
├──<span class="w"> </span>apps
│<span class="w">   </span>└──<span class="w"> </span>Application-argocd.yaml
└──<span class="w"> </span>argocd
<span class="w">    </span>├──<span class="w"> </span>ClusterRole-argocd-application-controller.yaml
<span class="w">    </span>├──<span class="w"> </span>ClusterRole-argocd-server.yaml
<span class="w">    </span>├──<span class="w"> </span>ClusterRoleBinding-argocd-application-controller.yaml
<span class="w">    </span>├──<span class="w"> </span>ClusterRoleBinding-argocd-server.yaml
<span class="w">    </span>├──<span class="w"> </span>ConfigMap-argocd-cmd-params-cm.yaml
<span class="w">    </span>└──<span class="w"> </span>...
</code></pre></div>
<p>And the contents of the Argo CD application automatically generated is the following:</p>
<div class="highlight"><span class="filename">apps/Application-argocd.yaml</span><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">argoproj.io/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Application</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># This is the name of the application (`applications.argocd`).</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">argocd</span><span class="w"> </span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">argocd</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">destination</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># This is the destination namespace for the application</span>
<span class="w">    </span><span class="c1"># specified with `applications.argocd.namespace`.</span>
<span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">argocd</span>
<span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://kubernetes.default.svc</span>
<span class="w">  </span><span class="nt">project</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">  </span><span class="nt">source</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># This is the output path declared for the application with</span>
<span class="w">    </span><span class="c1"># option `applications.output.path` (defaults to the name).</span>
<span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">argocd</span>
<span class="w">    </span><span class="c1"># Repository specified in `nixidy.target.repository`.</span>
<span class="w">    </span><span class="nt">repoURL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/arnarg/nixidy-demo.git</span>
<span class="w">    </span><span class="c1"># Branch specified in `nixidy.target.branch`.</span>
<span class="w">    </span><span class="nt">targetRevision</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">env/dev</span>
<span class="w">  </span><span class="nt">syncPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">automated</span><span class="p">:</span>
<span class="w">      </span><span class="nt">prune</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="nt">selfHeal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>
<p>A directory with rendered resources is generated for each application declared with <code>applications.&lt;name&gt;</code> as well as an Argo CD application resource YAML file in <code>apps/</code>. What this provides is the option to bootstrap the whole rendered branch to a cluster by adding an application pointing to the <code>apps/</code> folder.</p>
<p>See <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/cluster-bootstrapping/#app-of-apps-pattern">App of Apps Pattern</a>.</p>
<h2 id="modularizing-the-configuration">Modularizing the Configuration<a class="headerlink" href="#modularizing-the-configuration" title="Permanent link">#</a></h2>
<p>So far we've initialized the repository with <code>flake.nix</code> and a single environment with all options set in a single file (<code>env/dev.nix</code>). Next we'll want to add a <code>test</code> environment.</p>
<p>Adding a test environment is as simple as copying <code>env/dev.nix</code> to <code>env/test.nix</code>, renaming the target branch and adding that to <code>flake.nix</code> under <code>envs.test.modules</code>. This however will involve a lot of code duplication and the environment will need to be maintained completely separately.</p>
<p>Instead we should modularize the configuration into re-usable modules that can allow slight modification between environments (number of replicas, ingress domain, etc.).</p>
<p>To start this migration a <code>modules/default.nix</code> should be created.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Helm</label><label for="__tabbed_2_2">Kustomize</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><span class="filename">modules/default.nix</span><pre><span></span><code><span class="p">{</span>lib<span class="p">,</span> <span class="o">...</span><span class="p">}:</span> <span class="p">{</span>
  <span class="c1"># This option should be common across all environments so we</span>
  <span class="c1"># can declare it here.</span>
  nixidy<span class="o">.</span>target<span class="o">.</span><span class="ss">repository =</span> <span class="s2">&quot;https://github.com/arnarg/nixidy-demo.git&quot;</span><span class="p">;</span>

  <span class="c1"># Argo CD application using the Helm chart from argo-helm.</span>
  applications<span class="o">.</span><span class="ss">argocd =</span> <span class="p">{</span>
    <span class="c1"># Declare the destination namespace for the application.</span>
    <span class="ss">namespace =</span> <span class="s2">&quot;argocd&quot;</span><span class="p">;</span>

    <span class="c1"># Instruct nixidy to automatically create a `Namespace`</span>
    <span class="c1"># manifest in the rendered manifests for namespace</span>
    <span class="c1"># selected above.</span>
    <span class="ss">createNamespace =</span> <span class="no">true</span><span class="p">;</span>

    <span class="c1"># Specify Helm chart with values to template with.</span>
    helm<span class="o">.</span>releases<span class="o">.</span><span class="ss">argocd =</span> <span class="p">{</span>
      <span class="c1"># Using `downloadHelmChart` we can download</span>
      <span class="c1"># the helm chart using nix.</span>
      <span class="c1"># The value for `chartHash` needs to be updated</span>
      <span class="c1"># with each version.</span>
      <span class="ss">chart =</span> lib<span class="o">.</span>helm<span class="o">.</span>downloadHelmChart <span class="p">{</span>
        <span class="ss">repo =</span> <span class="s2">&quot;https://argoproj.github.io/argo-helm/&quot;</span><span class="p">;</span>
        <span class="ss">chart =</span> <span class="s2">&quot;argo-cd&quot;</span><span class="p">;</span>
        <span class="ss">version =</span> <span class="s2">&quot;5.51.6&quot;</span><span class="p">;</span>
        <span class="ss">chartHash =</span> <span class="s2">&quot;sha256-3kRkzOQdYa5JkrBV/+iJK3FP+LDFY1J8L20aPhcEMkY=&quot;</span><span class="p">;</span>
      <span class="p">};</span>

      <span class="c1"># Specify values to pass to the chart.</span>
      <span class="ss">values =</span> <span class="p">{</span>
        <span class="c1"># Run argocd-server with 2 replicas.</span>
        <span class="c1"># This is an option in the chart&#39;s `values.yaml`</span>
        <span class="c1"># usually declared like this:</span>
        <span class="c1">#</span>
        <span class="c1"># server:</span>
        <span class="c1">#   replicas: 2</span>
        server<span class="o">.</span><span class="ss">replicas =</span> <span class="mi">2</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><span class="filename">modules/default.nix</span><pre><span></span><code><span class="p">{</span>pkgs<span class="p">,</span> <span class="o">...</span><span class="p">}:</span> <span class="p">{</span>
  <span class="c1"># This option should be common across all environments so we</span>
  <span class="c1"># can declare it here.</span>
  nixidy<span class="o">.</span>target<span class="o">.</span><span class="ss">repository =</span> <span class="s2">&quot;https://github.com/arnarg/nixidy-demo.git&quot;</span><span class="p">;</span>

  <span class="c1"># Argo CD application using the official kustomize application</span>
  <span class="c1"># from Argo CD git repository.</span>
  applications<span class="o">.</span><span class="ss">argocd =</span> <span class="p">{</span>
    <span class="c1"># Declare the destination namespace for the application.</span>
    <span class="ss">namespace =</span> <span class="s2">&quot;argocd&quot;</span><span class="p">;</span>

    <span class="c1"># Instruct nixidy to automatically create a `Namespace`</span>
    <span class="c1"># manifest in the rendered manifests for namespace</span>
    <span class="c1"># selected above.</span>
    <span class="ss">createNamespace =</span> <span class="no">true</span><span class="p">;</span>

    <span class="c1"># Specify Kustomize application to render.</span>
    kustomize<span class="o">.</span>applications<span class="o">.</span><span class="ss">argocd =</span> <span class="p">{</span>
      <span class="c1"># Equivalent to `github.com/argoproj/argo-cd/manifests/cluster-install?ref=v2.9.3`</span>
      <span class="c1"># in kustomization.yaml.</span>
      <span class="ss">kustomization =</span> <span class="p">{</span>
        <span class="ss">src =</span> pkgs<span class="o">.</span>fetchFromGitHub <span class="p">{</span>
          <span class="ss">owner =</span> <span class="s2">&quot;argoproj&quot;</span><span class="p">;</span>
          <span class="ss">repo =</span> <span class="s2">&quot;argo-cd&quot;</span><span class="p">;</span>
          <span class="ss">rev =</span> <span class="s2">&quot;v2.9.3&quot;</span><span class="p">;</span>
          <span class="ss">hash =</span> <span class="s2">&quot;sha256-GaY4Cw/LlSwy35umbB4epXt6ev8ya19UjHRwhDwilqU=&quot;</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="ss">path =</span> <span class="s2">&quot;manifests/cluster-install&quot;</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>And in <code>flake.nix</code> we can now set it to use <code>modules/default.nix</code> as a common module like the following:</p>
<div class="highlight"><span class="filename">flake.nix</span><pre><span></span><code><span class="p">{</span>
  <span class="ss">description =</span> <span class="s2">&quot;My ArgoCD configuration with nixidy.&quot;</span><span class="p">;</span>

  inputs<span class="o">.</span>nixpkgs<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:nixos/nixpkgs/nixos-unstable&quot;</span><span class="p">;</span>
  inputs<span class="o">.</span>flake-utils<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:numtide/flake-utils&quot;</span><span class="p">;</span>
  inputs<span class="o">.</span>nixidy<span class="o">.</span><span class="ss">url =</span> <span class="s2">&quot;github:arnarg/nixidy&quot;</span><span class="p">;</span>

  <span class="ss">outputs =</span> <span class="p">{</span>
    self<span class="p">,</span>
    nixpkgs<span class="p">,</span>
    flake-utils<span class="p">,</span>
    nixidy<span class="p">,</span>
  <span class="p">}:</span> <span class="p">(</span>flake-utils<span class="o">.</span>lib<span class="o">.</span>eachDefaultSystem <span class="p">(</span>system<span class="p">:</span> <span class="k">let</span>
    <span class="ss">pkgs =</span> <span class="nb">import</span> nixpkgs <span class="p">{</span>
      <span class="k">inherit</span> system<span class="p">;</span>
    <span class="p">};</span>
  <span class="k">in</span> <span class="p">{</span>
    <span class="c1"># This declares the available nixidy envs.</span>
    <span class="ss">nixidyEnvs =</span> nixidy<span class="o">.</span>lib<span class="o">.</span>mkEnvs <span class="p">{</span>
      <span class="k">inherit</span> pkgs<span class="p">;</span>

      <span class="c1"># Modules to include in all envs.</span>
      <span class="ss">modules =</span> <span class="p">[</span><span class="o">.</span><span class="l">/modules</span><span class="p">];</span>

      <span class="ss">envs =</span> <span class="p">{</span>
        dev<span class="o">.</span><span class="ss">modules =</span> <span class="p">[</span><span class="o">.</span><span class="l">/env/dev.nix</span><span class="p">];</span>
        test<span class="o">.</span><span class="ss">modules =</span> <span class="p">[</span><span class="o">.</span><span class="l">/env/test.nix</span><span class="p">];</span>
      <span class="p">};</span>
    <span class="p">};</span>
  <span class="p">}));</span>
<span class="p">}</span>
</code></pre></div>
<p>Both environment specific files now only declare the target branch:</p>
<div class="highlight"><span class="filename">env/dev.nix</span><pre><span></span><code><span class="p">{</span>
  nixidy<span class="o">.</span>target<span class="o">.</span><span class="ss">branch =</span> <span class="s2">&quot;env/dev&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><span class="filename">env/test.nix</span><pre><span></span><code><span class="p">{</span>
  nixidy<span class="o">.</span>target<span class="o">.</span><span class="ss">branch =</span> <span class="s2">&quot;env/test&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="abstracting-options-on-top-of-applications">Abstracting Options on top of Applications<a class="headerlink" href="#abstracting-options-on-top-of-applications" title="Permanent link">#</a></h2>
<p>Now we have all common configuration in a module that is used across all environments and the next step is to also add traefik as an ingress controller. Oh! and we also want to create an ingress for Argo CD Web UI using the ingress controller. Also, come to think of it, We also don't want to run 2 replicas of argocd-server in the dev environment to save on resources.</p>
<p>Reaching these goals is simple enough by overriding the few needed options directly in the env specific configuration, for example:</p>
<div class="highlight"><span class="filename">env/dev.nix</span><pre><span></span><code><span class="p">{</span>lib<span class="p">,</span> <span class="o">...</span><span class="p">}:</span> <span class="p">{</span>
  <span class="c1"># ...</span>

  applications<span class="o">.</span>argocd<span class="o">.</span>helm<span class="o">.</span>releases<span class="o">.</span>argocd<span class="o">.</span><span class="ss">values =</span> <span class="p">{</span>
    <span class="c1"># Actually we want 1 replica only in dev.</span>
    server<span class="o">.</span><span class="ss">replicas =</span> lib<span class="o">.</span>mkForce <span class="mi">1</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<p>But this requires knowing the implementation details of the application and introduces tight coupling and things become hard to change for the argocd application.</p>
<p>Instead things should ideally be broken apart further and create an extra configuration interface on top. To achieve this we want to break the common modules into more files, or a module per application but with a common entrypoint.</p>
<h3 id="traefik">Traefik<a class="headerlink" href="#traefik" title="Permanent link">#</a></h3>
<p>Let's start by creating a module for traefik:</p>
<div class="highlight"><span class="filename">modules/traefik.nix</span><pre><span></span><code><span class="p">{</span>
  lib<span class="p">,</span>
  config<span class="p">,</span>
  <span class="o">...</span>
<span class="p">}:</span> <span class="p">{</span>
  options<span class="o">.</span>networking<span class="o">.</span><span class="ss">traefik =</span> <span class="k">with</span> lib<span class="p">;</span> <span class="p">{</span>
    <span class="ss">enable =</span> mkEnableOption <span class="s2">&quot;traefik ingress controller&quot;</span><span class="p">;</span>
    <span class="c1"># Exposing some options that _could_ be set directly</span>
    <span class="c1"># in the values option below can be useful for discoverability</span>
    <span class="c1"># and being able to reference in other modules</span>
    <span class="ss">ingressClass =</span> <span class="p">{</span>
      <span class="ss">enable =</span> mkOption <span class="p">{</span>
        <span class="ss">type =</span> types<span class="o">.</span>bool<span class="p">;</span>
        <span class="ss">default =</span> <span class="no">true</span><span class="p">;</span>
        <span class="ss">description =</span> <span class="s1">&#39;&#39;</span>
<span class="s1">          Whether or not an ingress class for traefik should be created automatically.</span>
<span class="s1">        &#39;&#39;</span><span class="p">;</span>
      <span class="p">};</span>
      <span class="ss">name =</span> mkOption <span class="p">{</span>
        <span class="ss">type =</span> types<span class="o">.</span>str<span class="p">;</span>
        <span class="ss">default =</span> <span class="s2">&quot;traefik&quot;</span><span class="p">;</span>
        <span class="ss">description =</span> <span class="s1">&#39;&#39;</span>
<span class="s1">          The name of the ingress class for traefik that should be created automatically.</span>
<span class="s1">        &#39;&#39;</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">};</span>
    <span class="c1"># To not limit the consumers of this module allowing for</span>
    <span class="c1"># setting the helm values directly is useful in certain</span>
    <span class="c1"># situations</span>
    <span class="ss">values =</span> mkOption <span class="p">{</span>
      <span class="ss">type =</span> types<span class="o">.</span>attrsOf types<span class="o">.</span>anything<span class="p">;</span>
      <span class="ss">default =</span> <span class="p">{};</span>
      <span class="ss">description =</span> <span class="s1">&#39;&#39;</span>
<span class="s1">        Value overrides that will be passed to the helm chart.</span>
<span class="s1">      &#39;&#39;</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>

  <span class="c1"># Only create the application if traefik is enabled</span>
  <span class="ss">config =</span> lib<span class="o">.</span>mkIf config<span class="o">.</span>networking<span class="o">.</span>traefik<span class="o">.</span>enable <span class="p">{</span>
    applications<span class="o">.</span><span class="ss">traefik =</span> <span class="p">{</span>
      <span class="ss">namespace =</span> <span class="s2">&quot;traefik&quot;</span><span class="p">;</span>
      <span class="ss">createNamespace =</span> <span class="no">true</span><span class="p">;</span>

      helm<span class="o">.</span>releases<span class="o">.</span><span class="ss">traefik =</span> <span class="p">{</span>
        <span class="ss">chart =</span> lib<span class="o">.</span>helm<span class="o">.</span>downloadHelmChart <span class="p">{</span>
          <span class="ss">repo =</span> <span class="s2">&quot;https://traefik.github.io/charts/&quot;</span><span class="p">;</span>
          <span class="ss">chart =</span> <span class="s2">&quot;traefik&quot;</span><span class="p">;</span>
          <span class="ss">version =</span> <span class="s2">&quot;25.0.0&quot;</span><span class="p">;</span>
          <span class="ss">chartHash =</span> <span class="s2">&quot;sha256-ua8KnUB6MxY7APqrrzaKKSOLwSjDYkk9tfVkb1bqkVM=&quot;</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="c1"># Here we merge default values with provided</span>
        <span class="c1"># values from `config.networking.traefik.values`.</span>
        <span class="ss">values =</span> lib<span class="o">.</span>recursiveUpdate <span class="p">{</span>
          <span class="ss">ingressClass =</span> <span class="p">{</span>
            <span class="ss">enabled =</span> config<span class="o">.</span>networking<span class="o">.</span>traefik<span class="o">.</span>ingressClass<span class="o">.</span>enable<span class="p">;</span>
            <span class="ss">name =</span> config<span class="o">.</span>networking<span class="o">.</span>traefik<span class="o">.</span>ingressClass<span class="o">.</span>name<span class="p">;</span>
          <span class="p">};</span>
        <span class="p">}</span> config<span class="o">.</span>networking<span class="o">.</span>traefik<span class="o">.</span>values<span class="p">;</span>
      <span class="p">};</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<p>Here we have declared extra configuration options that can be set in other modules. By setting <code class="highlight">networking<span class="o">.</span>traefik<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span></code> the <code>traefik</code> application will be added, otherwise not. By setting <code class="highlight">networking<span class="o">.</span>traefik<span class="o">.</span>ingressClass<span class="o">.</span><span class="ss">enable =</span> <span class="no">false</span><span class="p">;</span></code> the application will not contain an ingress class for traefik, and so on.</p>
<h3 id="argo-cd">Argo CD<a class="headerlink" href="#argo-cd" title="Permanent link">#</a></h3>
<p>Now let's create a specific module for Argo CD:</p>
<div class="highlight"><span class="filename">modules/argocd.nix</span><pre><span></span><code><span class="p">{</span>
  lib<span class="p">,</span>
  config<span class="p">,</span>
  <span class="o">...</span>
<span class="p">}:</span> <span class="p">{</span>
  options<span class="o">.</span>services<span class="o">.</span><span class="ss">argocd =</span> <span class="k">with</span> lib<span class="p">;</span> <span class="p">{</span>
    <span class="ss">enable =</span> mkEnableOption <span class="s2">&quot;argocd&quot;</span><span class="p">;</span>
    <span class="c1"># Configuration options for the ingress</span>
    <span class="ss">ingress =</span> <span class="p">{</span>
      <span class="ss">enable =</span> mkEnableOption <span class="s2">&quot;argocd ingress&quot;</span><span class="p">;</span>
      <span class="ss">host =</span> mkOption <span class="p">{</span>
        <span class="ss">type =</span> types<span class="o">.</span>nullOr types<span class="o">.</span>str<span class="p">;</span>
        <span class="ss">default =</span> <span class="no">null</span><span class="p">;</span>
        <span class="ss">description =</span> <span class="s1">&#39;&#39;</span>
<span class="s1">          Hostname to use in the Ingress for argocd-server.</span>
<span class="s1">        &#39;&#39;</span><span class="p">;</span>
      <span class="p">};</span>
      <span class="ss">ingressClassName =</span> mkOption <span class="p">{</span>
        <span class="ss">type =</span> types<span class="o">.</span>str<span class="p">;</span>
        <span class="ss">default =</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="ss">description =</span> <span class="s1">&#39;&#39;</span>
<span class="s1">          The ingress class to use in the Ingress for argocd-server.</span>
<span class="s1">        &#39;&#39;</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">};</span>
    <span class="c1"># Configuration option for setting the replicas for</span>
    <span class="c1"># argocd-server</span>
    <span class="ss">replicas =</span> mkOption <span class="p">{</span>
      <span class="ss">type =</span> types<span class="o">.</span>int<span class="p">;</span>
      <span class="ss">default =</span> <span class="mi">2</span><span class="p">;</span>
      <span class="ss">description =</span> <span class="s1">&#39;&#39;</span>
<span class="s1">        Number of replicas of the argocd-server deployment.</span>
<span class="s1">      &#39;&#39;</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="c1"># To not limit the consumers of this module allowing for</span>
    <span class="c1"># setting the helm values directly is useful in certain</span>
    <span class="c1"># situations</span>
    <span class="ss">values =</span> mkOption <span class="p">{</span>
      <span class="ss">type =</span> types<span class="o">.</span>attrsOf types<span class="o">.</span>anything<span class="p">;</span>
      <span class="ss">default =</span> <span class="p">{};</span>
      <span class="ss">description =</span> <span class="s1">&#39;&#39;</span>
<span class="s1">        Value overrides that will be passed to the helm chart.</span>
<span class="s1">      &#39;&#39;</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>

  <span class="c1"># Only create the application if argocd is enabled</span>
  <span class="ss">config =</span> lib<span class="o">.</span>mkIf config<span class="o">.</span>services<span class="o">.</span>argocd<span class="o">.</span>enable <span class="p">{</span>
    applications<span class="o">.</span><span class="ss">argocd =</span> <span class="p">{</span>
      <span class="ss">namespace =</span> <span class="s2">&quot;argocd&quot;</span><span class="p">;</span>
      <span class="ss">createNamespace =</span> <span class="no">true</span><span class="p">;</span>

      helm<span class="o">.</span>releases<span class="o">.</span><span class="ss">argocd =</span> <span class="p">{</span>
        <span class="ss">chart =</span> lib<span class="o">.</span>helm<span class="o">.</span>downloadHelmChart <span class="p">{</span>
          <span class="ss">repo =</span> <span class="s2">&quot;https://argoproj.github.io/argo-helm/&quot;</span><span class="p">;</span>
          <span class="ss">chart =</span> <span class="s2">&quot;argo-cd&quot;</span><span class="p">;</span>
          <span class="ss">version =</span> <span class="s2">&quot;5.51.6&quot;</span><span class="p">;</span>
          <span class="ss">chartHash =</span> <span class="s2">&quot;sha256-3kRkzOQdYa5JkrBV/+iJK3FP+LDFY1J8L20aPhcEMkY=&quot;</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="c1"># Here we merge default values with provided</span>
        <span class="c1"># values from `config.services.argocd.values`.</span>
        <span class="ss">values =</span> lib<span class="o">.</span>recursiveUpdate <span class="p">{</span>
          <span class="c1"># Set number of replicas by using service option</span>
          server<span class="o">.</span><span class="ss">replicas =</span> config<span class="o">.</span>services<span class="o">.</span>argocd<span class="o">.</span>replicas<span class="p">;</span>
          <span class="c1"># Create an ingress with the configured hostname</span>
          server<span class="o">.</span><span class="ss">ingress =</span> <span class="p">{</span>
            <span class="ss">enabled =</span> config<span class="o">.</span>services<span class="o">.</span>argocd<span class="o">.</span>ingress<span class="o">.</span>enable<span class="p">;</span>
            <span class="ss">ingressClassName =</span> config<span class="o">.</span>services<span class="o">.</span>argocd<span class="o">.</span>ingress<span class="o">.</span>ingressClassName<span class="p">;</span>
            <span class="ss">hosts =</span>
              <span class="k">if</span> <span class="o">!</span><span class="nb">isNull</span> config<span class="o">.</span>services<span class="o">.</span>argocd<span class="o">.</span>ingress<span class="o">.</span>host
              <span class="k">then</span> <span class="p">[</span>config<span class="o">.</span>services<span class="o">.</span>argocd<span class="o">.</span>ingress<span class="o">.</span>host<span class="p">]</span>
              <span class="k">else</span> <span class="p">[];</span>
          <span class="p">};</span>
        <span class="p">}</span> config<span class="o">.</span>services<span class="o">.</span>argocd<span class="o">.</span>values<span class="p">;</span>
      <span class="p">};</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<p>Like with the traefik module you can now set <code class="highlight">services<span class="o">.</span>argocd<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span></code> to enable the argocd application and <code class="highlight">services<span class="o">.</span>argocd<span class="o">.</span>ingress<span class="o">.</span><span class="ss">enable =</span> <span class="no">true</span><span class="p">;</span></code> to create an ingress.</p>
<h3 id="putting-it-all-together">Putting it all together<a class="headerlink" href="#putting-it-all-together" title="Permanent link">#</a></h3>
<p>Now with argocd and traefik declared in their own modules we will need to import them in the base <code>modules/default.nix</code>:</p>
<div class="highlight"><span class="filename">modules/default.nix</span><pre><span></span><code><span class="p">{</span>lib<span class="p">,</span> config<span class="p">,</span> <span class="o">...</span><span class="p">}:</span> <span class="p">{</span>
  <span class="c1"># Here we import the modules we created above.</span>
  <span class="c1"># This will make all the configuration options</span>
  <span class="c1"># available to other modules.</span>
  <span class="ss">imports =</span> <span class="p">[</span>
    <span class="o">.</span><span class="l">/argocd.nix</span>
    <span class="o">.</span><span class="l">/traefik.nix</span>
  <span class="p">];</span>

  <span class="c1"># This option should be common across all environments so we</span>
  <span class="c1"># can declare it here.</span>
  nixidy<span class="o">.</span>target<span class="o">.</span><span class="ss">repository =</span> <span class="s2">&quot;https://github.com/arnarg/nixidy-demo.git&quot;</span><span class="p">;</span>

  <span class="c1"># Traefik should be enable by default.</span>
  networking<span class="o">.</span>traefik<span class="o">.</span><span class="ss">enable =</span> lib<span class="o">.</span>mkDefault <span class="no">true</span><span class="p">;</span>

  <span class="c1"># Argo CD should be enabled by default.</span>
  services<span class="o">.</span><span class="ss">argocd =</span> <span class="p">{</span>
    <span class="ss">enable =</span> lib<span class="o">.</span>mkDefault <span class="no">true</span><span class="p">;</span>

    <span class="ss">ingress =</span> <span class="p">{</span>
      <span class="c1"># An ingress for Argo CD Web UI should</span>
      <span class="c1"># be created if traefik is also enabled.</span>
      <span class="ss">enable =</span> lib<span class="o">.</span>mkDefault config<span class="o">.</span>networking<span class="o">.</span>traefik<span class="o">.</span>enable<span class="p">;</span>

      <span class="c1"># The ingress should use Treafik&#39;s ingress</span>
      <span class="c1"># class.</span>
      <span class="ss">ingressClassName =</span> lib<span class="o">.</span>mkDefault config<span class="o">.</span>networking<span class="o">.</span>traefik<span class="o">.</span>ingressClass<span class="o">.</span>name<span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<p>This will import the two application modules and set some defaults by using <code>mkDefault</code> (this function sets the value as a default value but still allows overriding it in other modules). Notably we have set it up in a way that will automatically enable the ingress for Argo CD Web UI <em>if</em> traefik is also enabled, which is also enabled in this file but can be still be disabled in another module.</p>
<p>Now in order to achieve the goals we set out to achieve in the beginning of this section, the following options are set in the environments' configurations:</p>
<div class="highlight"><span class="filename">env/dev.nix</span><pre><span></span><code><span class="p">{</span>
  nixidy<span class="o">.</span>target<span class="o">.</span><span class="ss">branch =</span> <span class="s2">&quot;env/dev&quot;</span><span class="p">;</span>

  <span class="c1"># We want to set the hostname for ArgoCD Web UI</span>
  services<span class="o">.</span>argocd<span class="o">.</span>ingress<span class="o">.</span><span class="ss">host =</span> <span class="s2">&quot;argocd.dev.domain.com&quot;</span><span class="p">;</span>

  <span class="c1"># We only want 1 replica of argocd server</span>
  services<span class="o">.</span>argocd<span class="o">.</span><span class="ss">replicas =</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><span class="filename">env/test.nix</span><pre><span></span><code><span class="p">{</span>
  nixidy<span class="o">.</span>target<span class="o">.</span><span class="ss">branch =</span> <span class="s2">&quot;env/test&quot;</span><span class="p">;</span>

  <span class="c1"># We want to set the hostname for ArgoCD Web UI</span>
  services<span class="o">.</span>argocd<span class="o">.</span>ingress<span class="o">.</span><span class="ss">host =</span> <span class="s2">&quot;argocd.test.domain.com&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Now the following manifests are generated:</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;<span class="w"> </span>tree<span class="w"> </span>-l<span class="w"> </span>result
result
├──<span class="w"> </span>apps
│<span class="w">   </span>├──<span class="w"> </span>Application-argocd.yaml
│<span class="w">   </span>└──<span class="w"> </span>Application-traefik.yaml
├──<span class="w"> </span>argocd
│<span class="w">   </span>├──<span class="w"> </span>ClusterRole-argocd-application-controller.yaml
│<span class="w">   </span>├──<span class="w"> </span>ClusterRole-argocd-notifications-controller.yaml
│<span class="w">   </span>├──<span class="w"> </span>ClusterRole-argocd-repo-server.yaml
│<span class="w">   </span>├──<span class="w"> </span>ClusterRole-argocd-server.yaml
│<span class="w">   </span>├──<span class="w"> </span>ClusterRoleBinding-argocd-application-controller.yaml
│<span class="w">   </span>└──<span class="w"> </span>...
└──<span class="w"> </span>traefik
<span class="w">    </span>├──<span class="w"> </span>ClusterRoleBinding-traefik-traefik.yaml
<span class="w">    </span>├──<span class="w"> </span>ClusterRole-traefik-traefik.yaml
<span class="w">    </span>├──<span class="w"> </span>CustomResourceDefinition-ingressroutes-traefik-containo-us.yaml
<span class="w">    </span>├──<span class="w"> </span>CustomResourceDefinition-ingressroutes-traefik-io.yaml
<span class="w">    </span>├──<span class="w"> </span>CustomResourceDefinition-ingressroutetcps-traefik-containo-us.yaml
<span class="w">    </span>└──<span class="w"> </span>...
</code></pre></div>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../.." class="md-footer__link md-footer__link--prev" aria-label="Previous: Home" rel="prev">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Home
              </div>
            </div>
          </a>
        
        
          
          <a href="../github_actions/" class="md-footer__link md-footer__link--next" aria-label="Next: GitHub Actions" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                GitHub Actions
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.footer", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.dff1b7c8.min.js"></script>
      
    
  </body>
</html>